<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å­—å¹•ä¿®æ­£ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
    body { font-family: 'Noto Sans JP', sans-serif; }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95) translateY(10px); }
      to   { opacity: 1; transform: scale(1) translateY(0); }
    }

    .spinner {
      width: 20px; height: 20px;
      border: 3px solid #e9d5ff;
      border-top-color: #7c3aed;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }
    .fade-in  { animation: fadeIn  0.35s ease forwards; }
    .modal-in { animation: modalIn 0.25s ease forwards; }

    .drop-zone { transition: all 0.2s ease; }
    .drop-zone.drag-over {
      background-color: #f5f3ff;
      border-color: #7c3aed;
      transform: scale(1.02);
    }
    .progress-bar { transition: width 0.6s ease; }
    .step-spin { animation: spin 1s linear infinite; }

    .custom-scroll::-webkit-scrollbar { width: 5px; }
    .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #d8b4fe; border-radius: 4px; }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-white min-h-screen pb-16">

  <!-- ===== HEADER ===== -->
  <div class="bg-white/80 backdrop-blur-sm border-b border-purple-100 sticky top-0 z-20">
    <div class="max-w-xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-purple-600 to-pink-500 flex items-center justify-center text-white text-lg shrink-0">âœ¨</div>
      <div class="flex-1 min-w-0">
        <h1 class="text-sm font-bold text-gray-800 leading-tight">å­—å¹•ä¿®æ­£ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h1>
        <p id="headerSub" class="text-xs text-gray-400 truncate">Gemini AI ã§å­—å¹•ã‚’è‡ªå‹•ä¿®æ­£</p>
      </div>
      <!-- Settings button -->
      <button onclick="openSettings()" title="è¨­å®š"
        class="w-9 h-9 rounded-xl bg-gray-100 hover:bg-purple-100 flex items-center justify-center text-gray-500 hover:text-purple-700 transition shrink-0">
        âš™ï¸
      </button>
    </div>
  </div>

  <!-- ===== MAIN VIEW ===== -->
  <div class="max-w-xl mx-auto px-4 pt-6 space-y-4">

    <!-- Setup required notice (shown if no API key) -->
    <div id="setupNotice" class="hidden bg-amber-50 border border-amber-200 rounded-2xl p-4 fade-in">
      <div class="flex items-center gap-3">
        <span class="text-2xl shrink-0">ğŸ”‘</span>
        <div class="flex-1">
          <p class="text-sm font-semibold text-amber-800">æœ€åˆã«APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„</p>
          <p class="text-xs text-amber-600 mt-0.5">Google AI Studioï¼ˆç„¡æ–™ï¼‰ã§APIã‚­ãƒ¼ã‚’å–å¾—ã§ãã¾ã™</p>
        </div>
        <button onclick="openSettings()"
          class="shrink-0 text-xs font-bold text-white bg-amber-500 hover:bg-amber-600 px-3 py-1.5 rounded-lg transition">
          è¨­å®šã™ã‚‹ â†’
        </button>
      </div>
    </div>

    <!-- File Upload Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-purple-100 p-5 fade-in">
      <p class="text-xs font-medium text-gray-500 mb-3">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">

        <!-- å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ« -->
        <div>
          <label class="block text-xs font-semibold text-gray-600 mb-1.5">ğŸ¬ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«</label>
          <div id="videoDrop"
            class="drop-zone border-2 border-dashed border-gray-200 rounded-xl p-6 text-center cursor-pointer hover:border-purple-400 hover:bg-purple-50 select-none"
            onclick="document.getElementById('videoInput').click()"
            ondragover="onDragOver(event,'videoDrop')"
            ondragleave="onDragLeave('videoDrop')"
            ondrop="onDrop(event,'video','videoDrop')">
            <div id="videoEmpty">
              <div class="text-4xl mb-2">ğŸ¥</div>
              <p class="text-sm text-gray-500 font-medium">ã‚¿ãƒƒãƒ— or ãƒ‰ãƒ©ãƒƒã‚°</p>
              <p class="text-xs text-gray-400 mt-1">MP4 Â· MOV Â· AVI Â· MKV</p>
            </div>
            <div id="videoSelected" class="hidden">
              <div class="text-3xl mb-1.5">âœ…</div>
              <p class="text-sm font-semibold text-gray-700 break-all line-clamp-2" id="videoName"></p>
              <p class="text-xs text-purple-500 mt-1" id="videoSize"></p>
            </div>
          </div>
          <input type="file" id="videoInput" class="hidden" accept="video/*"
            onchange="selectFile('video', this.files[0])" />
        </div>

        <!-- SRTãƒ•ã‚¡ã‚¤ãƒ« -->
        <div>
          <label class="block text-xs font-semibold text-gray-600 mb-1.5">ğŸ“ SRTãƒ•ã‚¡ã‚¤ãƒ«</label>
          <div id="srtDrop"
            class="drop-zone border-2 border-dashed border-gray-200 rounded-xl p-6 text-center cursor-pointer hover:border-purple-400 hover:bg-purple-50 select-none"
            onclick="document.getElementById('srtInput').click()"
            ondragover="onDragOver(event,'srtDrop')"
            ondragleave="onDragLeave('srtDrop')"
            ondrop="onDrop(event,'srt','srtDrop')">
            <div id="srtEmpty">
              <div class="text-4xl mb-2">ğŸ“„</div>
              <p class="text-sm text-gray-500 font-medium">ã‚¿ãƒƒãƒ— or ãƒ‰ãƒ©ãƒƒã‚°</p>
              <p class="text-xs text-gray-400 mt-1">.srt ãƒ•ã‚¡ã‚¤ãƒ«</p>
            </div>
            <div id="srtSelected" class="hidden">
              <div class="text-3xl mb-1.5">âœ…</div>
              <p class="text-sm font-semibold text-gray-700 break-all line-clamp-2" id="srtName"></p>
              <p class="text-xs text-purple-500 mt-1" id="srtSize"></p>
            </div>
          </div>
          <input type="file" id="srtInput" class="hidden" accept=".srt,.txt"
            onchange="selectFile('srt', this.files[0])" />
        </div>

      </div>
    </div>

    <!-- Start Button -->
    <button id="startBtn" onclick="startProcess()" disabled
      class="w-full py-4 rounded-2xl font-bold text-base text-white shadow-md transition-all
             bg-gradient-to-r from-purple-600 to-pink-500
             disabled:opacity-40 disabled:cursor-not-allowed disabled:shadow-none
             enabled:hover:shadow-lg enabled:hover:scale-[1.02] enabled:active:scale-[0.99]">
      âœ¨ å­—å¹•ä¿®æ­£ã‚’é–‹å§‹ã™ã‚‹
    </button>

    <!-- Progress Card -->
    <div id="progressCard" class="hidden bg-white rounded-2xl shadow-sm border border-purple-100 p-5 fade-in">
      <div class="flex items-center gap-2 mb-5">
        <div class="spinner"></div>
        <h2 class="font-bold text-gray-800">å‡¦ç†ä¸­...</h2>
      </div>
      <div class="space-y-3 mb-5">
        <div class="flex items-center gap-3">
          <div id="s1i" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 text-sm font-bold flex items-center justify-center shrink-0">1</div>
          <div><p class="text-sm font-medium text-gray-700">å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p><p class="text-xs text-gray-400" id="s1sub">å¾…æ©Ÿä¸­</p></div>
        </div>
        <div class="flex items-center gap-3">
          <div id="s2i" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 text-sm font-bold flex items-center justify-center shrink-0">2</div>
          <div><p class="text-sm font-medium text-gray-700">å‹•ç”»ã‚’è§£æ</p><p class="text-xs text-gray-400" id="s2sub">å¾…æ©Ÿä¸­</p></div>
        </div>
        <div class="flex items-center gap-3">
          <div id="s3i" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 text-sm font-bold flex items-center justify-center shrink-0">3</div>
          <div><p class="text-sm font-medium text-gray-700">å­—å¹•ã‚’ä¿®æ­£</p><p class="text-xs text-gray-400" id="s3sub">å¾…æ©Ÿä¸­</p></div>
        </div>
        <div class="flex items-center gap-3">
          <div id="s4i" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 text-sm font-bold flex items-center justify-center shrink-0">4</div>
          <div><p class="text-sm font-medium text-gray-700">å®Œäº†</p><p class="text-xs text-gray-400" id="s4sub">å¾…æ©Ÿä¸­</p></div>
        </div>
      </div>
      <div class="bg-gray-100 rounded-full h-2.5 overflow-hidden">
        <div id="pbar" class="progress-bar h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full" style="width:0%"></div>
      </div>
      <p id="ptext" class="text-center text-xs text-gray-500 mt-2">æº–å‚™ä¸­...</p>
    </div>

    <!-- Error Card -->
    <div id="errorCard" class="hidden bg-red-50 border border-red-200 rounded-2xl p-5 fade-in">
      <div class="flex items-start gap-3">
        <span class="text-2xl shrink-0">âŒ</span>
        <div class="flex-1">
          <h2 class="font-bold text-red-800 mb-1">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
          <p id="errorMsg" class="text-sm text-red-700 leading-relaxed break-words"></p>
          <div class="mt-3 p-3 bg-red-100 rounded-lg">
            <p class="text-xs text-red-600 font-medium mb-1">ã‚ˆãã‚ã‚‹åŸå› ï¼š</p>
            <ul class="text-xs text-red-600 space-y-0.5 list-disc list-inside">
              <li>APIã‚­ãƒ¼ãŒæ­£ã—ããªã„ãƒ»æœŸé™åˆ‡ã‚Œ</li>
              <li>ç„¡æ–™æ ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸Šé™ã«é”ã—ãŸ</li>
              <li>å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã‚‹ï¼ˆä¸Šé™2GBï¼‰</li>
              <li>ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å‹•ç”»å½¢å¼</li>
            </ul>
          </div>
          <button onclick="dismissError()"
            class="mt-3 text-sm font-medium text-red-600 bg-white border border-red-300 px-4 py-1.5 rounded-lg hover:bg-red-50 transition">
            é–‰ã˜ã‚‹
          </button>
        </div>
      </div>
    </div>

    <!-- Result Card -->
    <div id="resultCard" class="hidden bg-white rounded-2xl shadow-sm border border-green-200 p-5 fade-in">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-xl">ğŸ‰</span>
        <h2 class="font-bold text-gray-800">ä¿®æ­£å®Œäº†ï¼</h2>
        <div class="ml-auto flex gap-2">
          <button onclick="copyResult()"
            class="text-xs font-medium text-gray-600 bg-gray-100 px-3 py-1.5 rounded-lg hover:bg-gray-200 transition">
            ğŸ“‹ ã‚³ãƒ”ãƒ¼
          </button>
          <button onclick="downloadResult()"
            class="text-xs font-bold text-white bg-gradient-to-r from-purple-600 to-pink-500 px-3 py-1.5 rounded-lg hover:shadow-md transition">
            â¬‡ï¸ ä¿å­˜
          </button>
        </div>
      </div>
      <div class="bg-gray-50 rounded-xl border border-gray-200 p-3 max-h-80 overflow-y-auto custom-scroll">
        <pre id="resultText" class="text-xs text-gray-700 whitespace-pre-wrap font-mono leading-relaxed"></pre>
      </div>
      <p class="text-xs text-gray-400 mt-2 text-center">å†…å®¹ã‚’ç¢ºèªå¾Œã€å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§ä¿®æ­£ã—ã¦ãã ã•ã„</p>
      <button onclick="resetAll()"
        class="w-full mt-3 py-2.5 rounded-xl text-sm font-medium text-purple-700 bg-purple-50 hover:bg-purple-100 transition">
        ğŸ”„ åˆ¥ã®å‹•ç”»ã‚’ä¿®æ­£ã™ã‚‹
      </button>
    </div>

  </div><!-- /main -->

  <!-- ===== SETTINGS MODAL ===== -->
  <div id="settingsOverlay" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-30 flex items-end sm:items-center justify-center p-4">
    <div class="modal-in bg-white w-full max-w-md rounded-2xl shadow-xl p-6 max-h-[90vh] overflow-y-auto">

      <div class="flex items-center justify-between mb-5">
        <h2 class="text-base font-bold text-gray-800">âš™ï¸ è¨­å®š</h2>
        <button onclick="closeSettings(false)" class="text-gray-400 hover:text-gray-600 text-xl leading-none">Ã—</button>
      </div>

      <!-- API Key -->
      <div class="mb-4">
        <div class="flex items-center justify-between mb-1">
          <label class="text-xs font-semibold text-gray-700">Gemini APIã‚­ãƒ¼</label>
          <a href="https://aistudio.google.com/app/apikey" target="_blank"
            class="text-xs text-purple-600 hover:underline">å–å¾—ã™ã‚‹ â†’</a>
        </div>
        <div class="relative">
          <input type="password" id="settingsApiKey"
            class="w-full border border-gray-200 rounded-xl px-3 py-2.5 pr-10 text-sm focus:outline-none focus:ring-2 focus:ring-purple-300 bg-gray-50"
            placeholder="AIza..." />
          <button onclick="toggleSettingsKey()" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">ğŸ‘ï¸</button>
        </div>
        <p class="text-xs text-gray-400 mt-1">ã‚­ãƒ¼ã¯ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚å¤–éƒ¨ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚</p>
      </div>

      <!-- Model -->
      <div class="mb-5">
        <label class="block text-xs font-semibold text-gray-700 mb-1">ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«</label>
        <select id="settingsModel"
          class="w-full border border-gray-200 rounded-xl px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-purple-300 bg-gray-50">
          <option value="gemini-2.5-flash">gemini-2.5-flashã€€ğŸ†“ ç„¡æ–™ï¼ˆæ¨å¥¨ï¼‰500å›/æ—¥</option>
          <option value="gemini-2.5-pro">gemini-2.5-proã€€ã€€ğŸ†“ ç„¡æ–™ï¼ˆé«˜ç²¾åº¦ï¼‰100å›/æ—¥</option>
          <option value="gemini-1.5-flash">gemini-1.5-flashã€€ğŸ†“ ç„¡æ–™ãƒ»æ—§ãƒ¢ãƒ‡ãƒ«</option>
        </select>
        <div class="mt-2 p-3 bg-purple-50 rounded-lg">
          <p class="text-xs text-purple-700 font-medium mb-1">ğŸ“Œ ç„¡æ–™æ ã®ç›®å®‰</p>
          <p class="text-xs text-purple-600">2.5 Flashï¼š10å›/åˆ†ã€500å›/æ—¥ï¼ˆé€šå¸¸ç”¨é€”ã«ååˆ†ï¼‰</p>
          <p class="text-xs text-purple-600">2.5 Proï¼š5å›/åˆ†ã€100å›/æ—¥ï¼ˆé«˜ç²¾åº¦ãŒå¿…è¦ãªå ´åˆï¼‰</p>
        </div>
      </div>

      <!-- Save Button -->
      <button onclick="saveSettings()"
        class="w-full py-3 rounded-xl font-bold text-white bg-gradient-to-r from-purple-600 to-pink-500 hover:shadow-md transition">
        ä¿å­˜ã™ã‚‹
      </button>

    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-sm px-5 py-2.5 rounded-full shadow-lg z-50 whitespace-nowrap">
    âœ… ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ
  </div>

  <!-- ===== SCRIPT ===== -->
  <script>
    /* ===== STATE ===== */
    let videoFile = null;
    let srtFile   = null;
    let correctedSRT = '';

    /* ===== STORAGE KEYS ===== */
    const KEY_API   = 'srt_api_key';
    const KEY_MODEL = 'srt_model';

    /* ===== INIT ===== */
    window.addEventListener('DOMContentLoaded', () => {
      const savedKey   = localStorage.getItem(KEY_API)   || '';
      const savedModel = localStorage.getItem(KEY_MODEL) || 'gemini-2.5-flash';

      document.getElementById('settingsApiKey').value = savedKey;
      document.getElementById('settingsModel').value  = savedModel;

      if (!savedKey) {
        // First visit â€” show settings immediately
        document.getElementById('settingsOverlay').classList.remove('hidden');
        document.getElementById('setupNotice').classList.remove('hidden');
      } else {
        updateHeaderSub(savedModel);
      }
      checkReady();
    });

    /* ===== SETTINGS ===== */
    function openSettings() {
      document.getElementById('settingsOverlay').classList.remove('hidden');
    }
    function closeSettings(saved) {
      document.getElementById('settingsOverlay').classList.add('hidden');
      if (saved && localStorage.getItem(KEY_API)) {
        document.getElementById('setupNotice').classList.add('hidden');
      }
    }
    function saveSettings() {
      const key   = document.getElementById('settingsApiKey').value.trim();
      const model = document.getElementById('settingsModel').value;
      if (!key) { alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      localStorage.setItem(KEY_API,   key);
      localStorage.setItem(KEY_MODEL, model);
      updateHeaderSub(model);
      closeSettings(true);
      checkReady();
      showToast('âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    }
    function toggleSettingsKey() {
      const el = document.getElementById('settingsApiKey');
      el.type = el.type === 'password' ? 'text' : 'password';
    }
    function updateHeaderSub(model) {
      document.getElementById('headerSub').textContent = `ãƒ¢ãƒ‡ãƒ«ï¼š${model}`;
    }

    /* ===== READY CHECK ===== */
    function checkReady() {
      const hasKey = !!localStorage.getItem(KEY_API);
      document.getElementById('startBtn').disabled = !(hasKey && videoFile && srtFile);
    }

    /* ===== FILE SELECT ===== */
    function fmt(bytes) {
      if (bytes < 1024)     return bytes + ' B';
      if (bytes < 1048576)  return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / 1048576).toFixed(1) + ' MB';
    }
    function selectFile(type, file) {
      if (!file) return;
      if (type === 'video') {
        videoFile = file;
        document.getElementById('videoEmpty').classList.add('hidden');
        document.getElementById('videoSelected').classList.remove('hidden');
        document.getElementById('videoName').textContent = file.name;
        document.getElementById('videoSize').textContent = fmt(file.size);
      } else {
        srtFile = file;
        document.getElementById('srtEmpty').classList.add('hidden');
        document.getElementById('srtSelected').classList.remove('hidden');
        document.getElementById('srtName').textContent = file.name;
        document.getElementById('srtSize').textContent = fmt(file.size);
      }
      checkReady();
    }
    function onDragOver(e, id) { e.preventDefault(); document.getElementById(id).classList.add('drag-over'); }
    function onDragLeave(id)   { document.getElementById(id).classList.remove('drag-over'); }
    function onDrop(e, type, id) {
      e.preventDefault();
      document.getElementById(id).classList.remove('drag-over');
      const f = e.dataTransfer.files[0];
      if (f) selectFile(type, f);
    }

    /* ===== PROGRESS ===== */
    function setStep(n, state, sub) {
      const icon = document.getElementById(`s${n}i`);
      if (sub) document.getElementById(`s${n}sub`).textContent = sub;
      if (state === 'active') {
        icon.className = 'w-8 h-8 rounded-full bg-purple-100 text-purple-600 text-sm font-bold flex items-center justify-center shrink-0 step-spin border-2 border-purple-400';
        icon.textContent = 'â³';
      } else if (state === 'done') {
        icon.className = 'w-8 h-8 rounded-full bg-green-100 text-green-600 text-sm font-bold flex items-center justify-center shrink-0';
        icon.textContent = 'âœ“';
      }
    }
    function setProgress(pct, text) {
      document.getElementById('pbar').style.width = pct + '%';
      if (text) document.getElementById('ptext').textContent = text;
    }

    /* ===== VIDEO UPLOAD (multipart â€” CORSå¯¾å¿œ) ===== */
    async function uploadVideo(file, apiKey) {
      const mimeType = file.type || 'video/mp4';

      // multipart/related å½¢å¼ã§çµ„ã¿ç«‹ã¦ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ä¸è¦ã§CORSãŒé€šã‚‹ï¼‰
      const boundary = '-------' + Date.now().toString(16);
      const metaJson = JSON.stringify({ file: { display_name: file.name, mimeType } });

      // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ† (JSON)
      const metaPart = `--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${metaJson}\r\n`;
      // ãƒ•ã‚¡ã‚¤ãƒ«éƒ¨åˆ†ã®ãƒ˜ãƒƒãƒ€ãƒ¼
      const fileHeader = `--${boundary}\r\nContent-Type: ${mimeType}\r\n\r\n`;
      const closing   = `\r\n--${boundary}--`;

      // Blob ã¨ã—ã¦çµåˆ
      const body = new Blob([metaPart, fileHeader, file, closing]);

      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST',
          `https://generativelanguage.googleapis.com/upload/v1beta/files?uploadType=multipart&key=${encodeURIComponent(apiKey)}`
        );
        xhr.setRequestHeader('Content-Type', `multipart/related; boundary=${boundary}`);

        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const pct = Math.round((e.loaded / e.total) * 100);
            setProgress(5 + pct * 0.35, `å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­... ${pct}%`);
          }
        };
        xhr.onload = () => {
          if (xhr.status === 200) {
            try { resolve(JSON.parse(xhr.responseText).file); }
            catch { reject(new Error('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ')); }
          } else {
            let msg = xhr.responseText.slice(0, 200);
            try { msg = JSON.parse(xhr.responseText)?.error?.message || msg; } catch {}
            if (xhr.status === 403 || xhr.status === 400) {
              reject(new Error(`APIã‚­ãƒ¼ã‚¨ãƒ©ãƒ¼ (${xhr.status}): ${msg}`));
            } else {
              reject(new Error(`å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•— (${xhr.status}): ${msg}`));
            }
          }
        };
        xhr.onerror = () => reject(new Error('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ã”ç¢ºèªãã ã•ã„ã€‚'));
        xhr.send(body);
      });
    }

    /* ===== WAIT ACTIVE ===== */
    async function waitActive(fileName, apiKey) {
      for (let i = 0; i < 90; i++) {
        const r = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/${fileName}?key=${encodeURIComponent(apiKey)}`
        );
        if (!r.ok) throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«çŠ¶æ…‹ã®ç¢ºèªå¤±æ•— (${r.status})`);
        const d = await r.json();
        if (d.state === 'ACTIVE') return d;
        if (d.state === 'FAILED') throw new Error('å‹•ç”»ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚MP4å½¢å¼ã‚’æ¨å¥¨ã—ã¾ã™ã€‚');
        setProgress(40 + Math.min(i * 0.5, 15), `å‹•ç”»ã‚’è§£æä¸­... (${(i+1)*2}ç§’)`);
        await new Promise(res => setTimeout(res, 2000));
      }
      throw new Error('å‹•ç”»å‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å‹•ç”»ã‚µã‚¤ã‚ºã‚’å°ã•ãã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    }

    /* ===== CALL GEMINI ===== */
    async function callGemini(fileUri, mimeType, srtContent, apiKey, model) {
      const prompt = `ã‚ãªãŸã¯ãƒ—ãƒ­ã®å‹•ç”»ç·¨é›†è€…ã§ã™ã€‚
æ·»ä»˜ã•ã‚ŒãŸå‹•ç”»ã®å†…å®¹ã‚’è¸ã¾ãˆã¦ã€ä»¥ä¸‹ã®SRTå­—å¹•ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

ä¿®æ­£ãƒ«ãƒ¼ãƒ«ï¼š
1. èª¤å­—è„±å­—ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
2. æ–‡è„ˆã‚’èª­ã¿å–ã‚Šã€ä¸è‡ªç„¶ãªæ”¹è¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚1è¡Œã®ãƒ†ãƒ­ãƒƒãƒ—ã¯æœ€å¤§20æ–‡å­—ç¨‹åº¦ã«ã—ã¦ãã ã•ã„ã€‚
3. è¦–è´è€…ãŒèª­ã¿ã‚„ã™ã„ã‚ˆã†ã«ã€å¥èª­ç‚¹ï¼ˆã€Œã€ã€ã‚„ã€Œã€‚ã€ï¼‰ã‚’é©åˆ‡ãªä½ç½®ã«è¿½åŠ ãƒ»å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
4. è©±ã—æ‰‹ã®æ„å›³ã‚„ä¼šè©±ã®ãƒ†ãƒ³ãƒã‚’å°Šé‡ã—ã€å…ƒã®æ–‡ç« ã®é›°å›²æ°—ã¯ãªã‚‹ã¹ãæ®‹ã—ã¦ãã ã•ã„ã€‚
5. ã€Œãˆãƒ¼ã€ã€Œã‚ã®ãƒ¼ã€ã¨ã„ã£ãŸã€æ„å‘³ã®ãªã„ã¤ãªãã®è¨€è‘‰ï¼ˆãƒ•ã‚£ãƒ©ãƒ¼ï¼‰ã¯å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
6. å­—å¹•ãƒ–ãƒ­ãƒƒã‚¯ã¯ã€è¦–è´è€…ãŒèª­ã¿ã‚„ã™ã„ã‚ˆã†ã€é©åˆ‡ãªé•·ã•ã¨æ•°ã«èª¿æ•´ã—ã¦ãã ã•ã„ã€‚è©±ã—æ‰‹ã®é–“ï¼ˆã¾ï¼‰ã‚„è¨€è‘‰ã®åŒºåˆ‡ã‚Šã‚’è€ƒæ…®ã—ã€è‡ªç„¶ãªãƒªã‚ºãƒ ã§è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
7. ä¿®æ­£å¾Œã‚‚SRTå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
8. ç§ã®å‹•ç”»ã¯ç¾å®¹ç³»ã®å•†å“ãŒãŸãã•ã‚“å‡ºã¦ãã‚‹ã®ã§ã€å•†å“åã¯ã—ã£ã‹ã‚Šã‚µãƒ¼ãƒã—ã€æ­£å¼åç§°ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚

é‡è¦ï¼šå‡ºåŠ›ã¯SRTå½¢å¼ã®ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚èª¬æ˜æ–‡ã‚„å‰ç½®ããƒ»ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯è¨˜å·ï¼ˆ\`\`\`ãªã©ï¼‰ã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„ã€‚

ä»¥ä¸‹ã®SRTå­—å¹•ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š

${srtContent}`;

      const res = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [
              { fileData: { mimeType, fileUri } },
              { text: prompt }
            ]}],
            generationConfig: { temperature: 0.2, maxOutputTokens: 16384 }
          })
        }
      );
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        const msg = err?.error?.message || res.statusText;
        if (res.status === 429) throw new Error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
        throw new Error(`Gemini APIã‚¨ãƒ©ãƒ¼ (${res.status}): ${msg}`);
      }
      const data = await res.json();
      if (!data.candidates?.length) throw new Error('Geminiã‹ã‚‰ã®å¿œç­”ãŒç©ºã§ã—ãŸã€‚ãƒ¢ãƒ‡ãƒ«ã‚„å…¥åŠ›å†…å®¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
      return data.candidates[0].content.parts[0].text;
    }

    /* ===== EXTRACT SRT ===== */
    function extractSRT(text) {
      const block = text.match(/```(?:srt)?\s*\n([\s\S]*?)```/);
      if (block) return block[1].trim();
      if (/^\d+\s*\n\d{2}:\d{2}:\d{2}/.test(text.trim())) return text.trim();
      return text.trim();
    }

    /* ===== MAIN ===== */
    async function startProcess() {
      const apiKey = localStorage.getItem(KEY_API);
      const model  = localStorage.getItem(KEY_MODEL) || 'gemini-2.5-flash';
      if (!apiKey) { openSettings(); return; }

      document.getElementById('startBtn').disabled = true;
      document.getElementById('progressCard').classList.remove('hidden');
      document.getElementById('resultCard').classList.add('hidden');
      document.getElementById('errorCard').classList.add('hidden');
      document.getElementById('progressCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      try {
        // Read SRT
        const srtContent = await new Promise((res, rej) => {
          const reader = new FileReader();
          reader.onload = e => res(e.target.result);
          reader.onerror = () => rej(new Error('SRTãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
          reader.readAsText(srtFile, 'UTF-8');
        });

        // Step 1: Upload
        setStep(1, 'active', 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æº–å‚™ä¸­...');
        setProgress(3, 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹...');
        const uploaded = await uploadVideo(videoFile, apiKey);
        setStep(1, 'done', `å®Œäº† (${fmt(videoFile.size)})`);

        // Step 2: Analyze
        setStep(2, 'active', 'è§£æã‚’å¾…æ©Ÿä¸­...');
        setProgress(40, 'å‹•ç”»ã‚’è§£æä¸­...');
        await waitActive(uploaded.name, apiKey);
        setStep(2, 'done', 'è§£æå®Œäº†');

        // Step 3: Generate
        setStep(3, 'active', 'AIãŒå­—å¹•ã‚’ä¿®æ­£ä¸­...');
        setProgress(65, 'GeminiãŒå­—å¹•ã‚’ä¿®æ­£ä¸­ï¼ˆå°‘ã€…ãŠå¾…ã¡ãã ã•ã„ï¼‰...');
        const raw = await callGemini(uploaded.uri, videoFile.type || 'video/mp4', srtContent, apiKey, model);
        setStep(3, 'done', 'ä¿®æ­£å®Œäº†');

        // Step 4: Done
        setStep(4, 'done', '');
        setProgress(100, 'å®Œäº†ï¼');
        correctedSRT = extractSRT(raw);

        await new Promise(r => setTimeout(r, 600));
        document.getElementById('progressCard').classList.add('hidden');
        document.getElementById('resultCard').classList.remove('hidden');
        document.getElementById('resultText').textContent = correctedSRT;
        document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth', block: 'start' });

      } catch (err) {
        document.getElementById('progressCard').classList.add('hidden');
        document.getElementById('errorCard').classList.remove('hidden');
        document.getElementById('errorMsg').textContent = err.message;
        document.getElementById('startBtn').disabled = false;
      }
    }

    /* ===== RESULT ACTIONS ===== */
    function downloadResult() {
      const name = (srtFile?.name || 'subtitle').replace(/\.srt$/i, '');
      const blob = new Blob([correctedSRT], { type: 'text/plain;charset=utf-8' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = `${name}_ä¿®æ­£æ¸ˆã¿.srt`;
      a.click();
      URL.revokeObjectURL(url);
    }
    async function copyResult() {
      try {
        await navigator.clipboard.writeText(correctedSRT);
        showToast('âœ… ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      } catch {
        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
      }
    }

    /* ===== RESET ===== */
    function resetAll() {
      videoFile = null; srtFile = null; correctedSRT = '';
      ['videoEmpty','srtEmpty'].forEach(id => document.getElementById(id).classList.remove('hidden'));
      ['videoSelected','srtSelected'].forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById('videoInput').value = '';
      document.getElementById('srtInput').value   = '';
      document.getElementById('resultCard').classList.add('hidden');
      document.getElementById('progressCard').classList.add('hidden');
      document.getElementById('pbar').style.width = '0%';
      [1,2,3,4].forEach(n => {
        const icon = document.getElementById(`s${n}i`);
        icon.className = 'w-8 h-8 rounded-full bg-gray-100 text-gray-400 text-sm font-bold flex items-center justify-center shrink-0';
        icon.textContent = n;
        document.getElementById(`s${n}sub`).textContent = 'å¾…æ©Ÿä¸­';
      });
      checkReady();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function dismissError() {
      document.getElementById('errorCard').classList.add('hidden');
      document.getElementById('startBtn').disabled = false;
      checkReady();
    }

    /* ===== TOAST ===== */
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 2200);
    }

    /* ===== CLOSE MODAL ON OVERLAY CLICK ===== */
    document.getElementById('settingsOverlay').addEventListener('click', (e) => {
      if (e.target === document.getElementById('settingsOverlay')) {
        if (localStorage.getItem(KEY_API)) closeSettings(false);
      }
    });
  </script>
</body>
</html>